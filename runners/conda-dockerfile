FROM  condaforge/mambaforge

ADD ./r-environment.yml /data/r-environment.yml

WORKDIR /data

RUN mamba init

# Since we are using the user from the client computer to run the scripts,
# we need to create and open the permissions of a few directories.
RUN chmod a+w /data

# Conda cache and environments folder will be replaced by a virtual volume, but we want them to be writable by the runtime user.
# Permissions cannot be defined at mount time, hence we create empty folder with the appropriate permissions.
RUN mkdir /.cache && mkdir /.cache/conda && chmod a+w /.cache/conda
RUN mkdir /.conda && chmod a+w /.conda

# Allow to read bashrc to execute mamba init when using docker exec
# See https://stackoverflow.com/a/74017557/3519951
RUN sed -e '/[ -z "$PS1" ] && return/s/^/#/g' -i /root/.bashrc

RUN mamba env create -f /data/r-environment.yml

# These packages are not in conda-forge
RUN bash --login -c "mamba activate rbase; R -e 'install.packages(c(\"CoordinateCleaner\", \"geodata\", \"OpenStreetMap\"), repos=\"https://cloud.r-project.org/\")'"

# Packages from GitHub
RUN bash --login -c "mamba activate rbase; R -e 'devtools::install_github(\"ReseauBiodiversiteQuebec/stac-catalogue\")'"

RUN date +"%Y-%m-%d %R" > /version.txt
