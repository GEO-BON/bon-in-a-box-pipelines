FROM  condaforge/mambaforge

ADD ./r-environment.yml /data/r-environment.yml

WORKDIR /data

RUN mamba init

# Since we are using the user from the client computer to run the scripts,
# we need to create and open the permissions of a few directories.
RUN chmod a+w /data

# Conda cache and environments folder will be replaced by a virtual volume, but we want them to be writable by the runtime user.
# Permissions cannot be defined at mount time, hence we create empty folder with the appropriate permissions.
RUN mkdir /.cache && mkdir /.cache/conda && chmod a+w /.cache/conda
RUN mkdir /.conda && chmod a+w /.conda
RUN mkdir /r-libs-user && chmod a+w /r-libs-user
RUN mkdir /conda-env-yml && chmod a+w /conda-env-yml
RUN touch .condarc && chmod 777 .condarc

# Allow to read bashrc to execute mamba init when using docker exec
# See https://stackoverflow.com/a/74017557/3519951
RUN sed -e '/[ -z "$PS1" ] && return/s/^/#/g' -i /root/.bashrc

RUN mamba env create -f /data/r-environment.yml

# Hide "error libmamba Could not open lockfile '/opt/conda/pkgs/cache/cache.lock'" when installing manually with non-root user
# That error would not prevent the correct installation, but it looked like it to the user.
RUN chmod -R 777 /opt/conda/pkgs/cache

# This library should be leaded by default all the time, since we need to read inputs and write outputs in R.
RUN conda config --add create_default_packages r-rjson

# This fixes a problem with R package sf, where it cannot be loaded in an environment that was just created.
# The other workaround was to create AND update the conda environment.
RUN conda config --add create_default_packages r-sf

# These packages are not in conda-forge
# ADD CRAN PACKAGES HERE
RUN bash --login -c "mamba activate rbase; R -e 'install.packages(c(\"CoordinateCleaner\", \
        \"geodata\", \
        \"OpenStreetMap\"\
    ), repos=\"https://cloud.r-project.org/\")'"



# ADD GITHUB PACKAGES HERE
RUN bash --login -c "mamba activate rbase; R -e 'devtools::install_github(\"ReseauBiodiversiteQuebec/stac-catalogue\")'"
RUN bash --login -c "mamba activate rbase; R -e 'devtools::install_github(\"connectscape/Makurhini\")'"

RUN date +"%Y-%m-%d %R" > /version.txt
