---
title: "Calculating the mean of several layers"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library("gdalcubes")
library("rstac")
library("tibble")
library("sp")
library("sf")
library("dplyr")
library("rgbif")
library("tidyr")
library("stars")
```


```{r cars, echo=FALSE}
source("stac_functions.R")
```


### Loading observations

Let's download [Glyptemys insculpta](https://en.wikipedia.org/wiki/Wood_turtle) observations from GBIF.

```{r}
obs <- rgbif::occ_data(scientificName = "Glyptemys insculpta", hasCoordinate = TRUE, limit = 1000)
obs <- dplyr::select(obs$data, decimalLongitude, decimalLatitude) %>%
  dplyr::rename(lon = decimalLongitude) %>%
  dplyr::rename(lat = decimalLatitude) 
head(obs)
```

We reproject the decimal longitude and latitude to a user-specified projection system. This conversion to a projected system is essential to interact with the cube.

```{r}
srs.obs <-"EPSG:4326" # initial observations projection system
srs.cube <- "EPSG:6623" # targeted projected projection system
obs.coords.proj <- create_projection(obs, lon = "lon", lat = "lat", 
                                       srs.obs, srs.cube)

```

We load the coad for 3 months, tasmax variable
```{r, warning=FALSE}
cube <- 
  load_cube(stac_path = "http://io.biodiversite-quebec.ca/stac/",
           limit = 5000, 
           collections = c("chelsa-monthly"), 
           use.obs = T,
           obs = obs.coords.proj,
           buffer.box = 0,
           srs.cube = srs.cube,
           t0 = "2016-01-01",
           t1 = "2016-03-01",
           variable = "tasmax",
           spatial.res = 1000, # in meters
           temporal.res = "P1Y",
           aggregation = "mean",
           resampling = "near") 


```

First, we download the values of points for each layer: 

```{r, warning=FALSE}

values <- gdalcubes::extract_geom(cube, sf::st_as_sf(obs.coords.proj, coords = c("lon", "lat"),
                                                           crs = srs.cube)) %>% dplyr::select(-time)
head(values)
```

We manually calculate their mean:
```{r, warning=FALSE}
values <- values %>% dplyr::mutate(mean_manual = rowMeans(select(values, starts_with("tasmax"))))

```


Now we use gdalcubes function to create a mean layer. First, we create the expression:
```{r, warning=FALSE}
sum_bands <-  paste(names(cube), collapse="+")
mean_bands <- sprintf("(%s)/%i", sum_bands, length(names(cube)))
mean_bands
# apply to each pixel the next function
```
```{r, warning=FALSE}
tmean_cube <- apply_pixel(cube, mean_bands, names = "mean_tmean")
values.auto <- gdalcubes::extract_geom(tmean_cube, sf::st_as_sf(obs.coords.proj, coords = c("lon", "lat"),
                                                           crs = srs.cube)) %>% dplyr::select(-time)
values <- dplyr::left_join(values, values.auto, by = "FID")
head(values)
```

