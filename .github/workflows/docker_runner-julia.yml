name: Julia Runner

on:
  workflow_dispatch:
  push:
    branches:
      - main
      - edge
      - '*staging'
    paths:
      - '.github/workflows/docker_runner-julia.yml'
      - 'runners/julia/**'

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}/runner-julia

jobs:

  prepare:
    runs-on: ubuntu-latest
    outputs:
      ghcr_slug: ${{ steps.slug.outputs.ghcr_slug }}
    steps:
      - name: Compute lowercase GHCR slug
        id: slug
        shell: bash
        run: |
          echo "ghcr_slug=ghcr.io/${GITHUB_REPOSITORY@L}" >> "$GITHUB_OUTPUT"

  build:
    needs: prepare
    env:
      GHCR_SLUG: ${{ needs.prepare.outputs.ghcr_slug }}
    timeout-minutes: 60
    strategy:
      matrix:
        include:
          # Get base image platforms with
          # docker buildx imagetools inspect julia:1.12 | grep Platform
          # Excluding windows/amd64 for now since we would need a separate builder.
          # Excluding linux/386 since this points to old 32-bit processor machines and it fails to compile.
          - platform: linux/amd64
            runs_on: ubuntu-latest
            arch_tag: amd64
          - platform: linux/arm64
            runs_on: ubuntu-24.04-arm
            arch_tag: arm64
    runs-on: ${{ matrix.runs_on }}
    permissions:
      contents: read
      packages: write

    steps:
      - name: Check out the repo
        uses: actions/checkout@v4

      - name: Log in to GitHub Packages
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Buildx
        uses: docker/setup-buildx-action@v3
        with:
          driver: docker-container # compatible for caching to GHA/registry

      - name: Extract metadata (tags, labels) for Docker
        id: metadata
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.GHCR_SLUG }}/${{ env.IMAGE_NAME }}
          tags: |
            # Image used in compose file
            type=raw,value=${{ (github.ref_name == 'main' && 'latest') || github.ref_name }}-${{ matrix.arch_tag }}
            # In case we want to replicate a specific legacy setup
            type=sha,value=${{ github.sha }}-${{ matrix.arch_tag }}
          labels: |
            org.opencontainers.image.licenses=GPL-v3
            org.opencontainers.image.title=BON in a Box Julia Runner

      - name: Build and push Docker image per architecture
        id: push
        uses: docker/build-push-action@v6
        with:
          context: runners/julia
          file: runners/julia/julia-dockerfile
          platforms: ${{ matrix.platform }}
          push: true
          tags: ${{ steps.metadata.outputs.tags }}
          labels: ${{ steps.metadata.outputs.labels }}
          cache-from: type=registry,ref=${{ env.GHCR_SLUG }}/${{ env.IMAGE_NAME }}:buildcache-${{ matrix.arch_tag }}-${{ github.ref_name }}
          cache-to: type=registry,ref=${{ env.GHCR_SLUG }}/${{ env.IMAGE_NAME }}:buildcache-${{ matrix.arch_tag }}-${{ github.ref_name }},mode=max

  manifest:
    runs-on: ubuntu-latest
    needs: [build, prepare]
    env:
      GHCR_SLUG: ${{ needs.prepare.outputs.ghcr_slug }}
    permissions:
      contents: read
      packages: write
    steps:
      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Create and push manifest
        run: |
          # exemples de tags "agrégés"
          TAG_MAIN="${{ github.ref_name == 'main' && 'latest' || github.ref_name }}"
          TAG_SHA="sha-${{ github.sha }}"
          BASE="${{ env.GHCR_SLUG }}/${{ env.IMAGE_NAME }}"

          docker buildx imagetools create \
            -t "${BASE}:${TAG_MAIN}" \
            -t "${BASE}:${TAG_SHA}" \
            "${BASE}:${TAG_MAIN}-amd64" \
            "${BASE}:${TAG_MAIN}-arm64"
